<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Prisma Access íƒœê¹… ì‹œìŠ¤í…œ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>í™˜ì˜í•©ë‹ˆë‹¤, David!</h1>
    <p>ë‹¹ì‹ ì˜ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì— ë”°ë¼ ìë™ìœ¼ë¡œ íƒœê¹…ë©ë‹ˆë‹¤.</p>

    <div id="status">
      <span class="icon">ğŸ”„</span>
      <span class="message">ìœ„ì¹˜ í™•ì¸ ì¤‘...</span>
    </div>
    <div id="ip-info">IP í™•ì¸ ì¤‘...</div>

    <div id="end-tag" style="display: none;">
      <button onclick="endTagging()">íƒœê·¸ ì¢…ë£Œ</button>
    </div>
  </div>

  <script>
    let currentIP = null;

    function endTagging() {
      if (!currentIP) return;

      fetch("https://secure.cloude.co.kr/end/tag", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ip: currentIP })
      })
      .then(res => res.json())
      .then(data => {
        document.body.classList.remove("internal", "external");
        document.querySelector(".message").innerText = "íƒœê¹… ì¢…ë£Œë¨: " + data.status;
        document.querySelector(".icon").innerText = "âœ…";
        document.getElementById("end-tag").style.display = "none";
      });
    }

    fetch("https://api.ipify.org?format=json")
      .then(res => res.json())
      .then(data => {
        currentIP = data.ip;
        document.getElementById("ip-info").innerText = `IP: ${currentIP}`;

        fetch("/get-tag-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ip: currentIP })
        })
        .then(res => res.json())
        .then(data => {
          const tagUrl = data.tag === "internal"
            ? "https://secure.cloude.co.kr/internal/tag"
            : "https://secure.cloude.co.kr/external/tag";

          fetch(tagUrl, {
            method: "POST",
            headers: {
              "Authorization": "Bearer " + data.token,
              "Content-Type": "application/json"
            }
          })
          .then(res => res.json())
          .then(result => {
            document.body.classList.add(result.tag);
            document.querySelector(".message").innerText = `${result.tag} íƒœê¹… ì™„ë£Œ`;
            document.querySelector(".icon").innerText = result.tag === "internal" ? "ğŸ¢" : "ğŸŒ";
            document.getElementById("end-tag").style.display = "block";
          });
        });
      });
  </script>
</body>
</html>